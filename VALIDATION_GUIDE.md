# TFLite模型验证指南

本指南介绍如何验证量化后的TFLite模型在各个类别数据集上的准确性。

## 验证脚本概述

### 1. 完整验证脚本 (推荐)

**文件**: `validate_tflite_model.py`

**功能**:
- 完整的模型评估框架
- 支持所有量化类型（FLOAT32, FLOAT16, INT8, INT8 Full）
- 生成详细的评估报告
- 计算混淆矩阵
- 逐类别性能分析（精确率、召回率、F1分数）
- 错误样本分析
- 模型对比功能
- 结果保存为JSON

**特点**:
- 自动处理不同格式的NPZ数据文件
- 支持INT8量化/反量化
- 详细的性能指标
- 可视化友好的输出格式

### 2. 简化验证脚本 (快速)

**文件**: `validate_simple.py`

**功能**:
- 快速验证模型准确性
- 测试每个类别的识别准确率
- 显示预测分布
- 简单易懂的输出

**特点**:
- 代码简洁，易于理解和修改
- 适合快速检查模型性能
- 适合初学者

## 使用方法

### 准备工作

1. **确保已安装依赖**:
```bash
uv pip install tensorflow>=2.8.4 "numpy<2.0"
```

2. **生成TFLite模型** (如果还没有):
```bash
# 完整版本（使用真实数据校准）
python convert_to_tflite.py

# 或简化版本（使用合成数据）
python convert_simple.py
```

3. **确保数据集存在**:
```
model/datasets/ST_VL53L8CX_handposture_dataset/
├── None/
├── Like/
├── Dislike/
├── FlatHand/
├── Fist/
├── Love/
├── BreakTime/
└── CrossHands/
```

### 方法1: 使用完整验证脚本

```bash
python validate_tflite_model.py
```

**交互式菜单**:
```
请选择评估模式:
1. 评估单个模型（详细分析）
2. 对比所有模型

输入选项 (1 或 2): 1

可用的模型:
  1. hand_posture_float32.tflite ✓
  2. hand_posture_float16.tflite ✓
  3. hand_posture_int8.tflite ✓
  4. hand_posture_int8_full.tflite ✓

选择要评估的模型编号: 4
```

**输出示例**:
```
======================================================================
评估结果
======================================================================

总体准确率: 0.9943 (99.43%)

平均置信度: 0.9876

混淆矩阵:
真实\预测        None        Like     Dislike    FlatHand        Fist        Love   BreakTime  CrossHands
None                150           0           0           0           0           0           0           0
Like                  0         145           1           0           0           0           0           0
Dislike               0           0         148           0           0           0           0           0
FlatHand              0           0           0         142           0           0           0           0
Fist                  0           0           0           0         139           0           1           0
Love                  0           0           0           0           0         144           0           0
BreakTime             0           0           0           0           2           0         140           0
CrossHands            0           0           0           0           0           0           0         138

----------------------------------------------------------------------
各类别详细指标:
----------------------------------------------------------------------
类别          精确率      召回率      F1分数      样本数
----------------------------------------------------------------------
None           1.0000     1.0000     1.0000         150
Like           1.0000     0.9932     0.9966         146
Dislike        0.9933     1.0000     0.9966         148
FlatHand       1.0000     1.0000     1.0000         142
Fist           0.9858     0.9929     0.9893         140
Love           1.0000     1.0000     1.0000         144
BreakTime      0.9929     0.9859     0.9894         142
CrossHands     1.0000     1.0000     1.0000         138
----------------------------------------------------------------------
加权平均       0.9977     0.9943     0.9960        1150
======================================================================
```

**错误分析输出**:
```
======================================================================
错误样本分析
======================================================================

错误预测数量: 7 / 1150 (0.61%)

置信度最高的 5 个错误样本:
----------------------------------------------------------------------
编号   真实类别      预测类别        置信度
----------------------------------------------------------------------
523    Like         Dislike        0.8234
891    Fist         BreakTime      0.7892
892    BreakTime    Fist           0.7654
```

### 方法2: 使用简化验证脚本

```bash
python validate_simple.py
```

**输出示例**:
```
============================================================
TFLite模型验证
============================================================

加载模型: model/tflite/hand_posture_int8_full.tflite
输入: [ 1  8  8  2] - <class 'numpy.int8'>
输出: [1 8] - <class 'numpy.int8'>

============================================================
测试各个类别
============================================================

测试类别: None (索引 0)
  加载了 20 个样本
  准确率: 20/20 = 100.0%
  预测分布:
    None        :  20 (100.0%)

测试类别: Like (索引 1)
  加载了 20 个样本
  准确率: 19/20 = 95.0%
  预测分布:
    Like        :  19 (95.0%)
    Dislike     :   1 (5.0%)

...

============================================================
验证总结
============================================================

总体准确率: 156/160 = 97.5%

各类别准确率:
类别          准确率   正确数   总数
------------------------------------------------------------
None           100.0%       20     20
Like            95.0%       19     20
Dislike        100.0%       20     20
FlatHand       100.0%       20     20
Fist            95.0%       19     20
Love           100.0%       20     20
BreakTime       90.0%       18     20
CrossHands     100.0%       20     20
============================================================

优秀! 模型性能良好，可以部署到Arduino
```

### 方法3: 模型对比模式

```bash
python validate_tflite_model.py
# 选择选项 2
```

**输出示例**:
```
======================================================================
模型对比摘要
======================================================================
模型名称                                        准确率
----------------------------------------------------------------------
hand_posture_float32.tflite                    0.9965
hand_posture_float16.tflite                    0.9943
hand_posture_int8.tflite                       0.9921
hand_posture_int8_full.tflite                  0.9886
======================================================================
```

## 输出文件

### JSON评估报告

验证完成后会生成JSON文件，例如：
```
model/tflite/hand_posture_int8_full_evaluation.json
```

**内容包括**:
```json
{
  "accuracy": 0.9943,
  "mean_confidence": 0.9876,
  "confusion_matrix": [[150, 0, ...], ...],
  "class_metrics": {
    "None": {
      "precision": 1.0,
      "recall": 1.0,
      "f1_score": 1.0,
      "support": 150
    },
    ...
  },
  "model_path": "model/tflite/hand_posture_int8_full.tflite",
  "dataset_path": "model/datasets/ST_VL53L8CX_handposture_dataset",
  "num_samples": 1150
}
```

## 性能指标说明

### 1. 准确率 (Accuracy)
- **定义**: 正确预测的样本数 / 总样本数
- **目标**: > 95% 为良好，> 98% 为优秀

### 2. 精确率 (Precision)
- **定义**: 真阳性 / (真阳性 + 假阳性)
- **含义**: 预测为某类别的样本中，实际为该类别的比例

### 3. 召回率 (Recall)
- **定义**: 真阳性 / (真阳性 + 假阴性)
- **含义**: 实际为某类别的样本中，被正确预测的比例

### 4. F1分数 (F1 Score)
- **定义**: 2 × (精确率 × 召回率) / (精确率 + 召回率)
- **含义**: 精确率和召回率的调和平均数

### 5. 置信度 (Confidence)
- **定义**: 模型对预测结果的信心程度
- **范围**: 0.0 - 1.0
- **目标**: > 0.9 为高置信度

## 常见问题排查

### 问题1: 准确率异常低 (< 50%)

**可能原因**:
1. 预处理参数不正确
2. 量化参数未正确应用
3. NPZ数据加载错误

**解决方案**:
```python
# 检查数据加载
import numpy as np
data = np.load("sample.npz")
print(data.files)  # 查看可用字段
print(data['distance_mm'].shape)  # 检查形状
```

### 问题2: INT8模型准确率明显低于FLOAT32

**可能原因**:
- 量化校准数据不足或质量差
- 模型对量化敏感

**解决方案**:
```bash
# 使用真实数据集重新量化
python convert_to_tflite.py
# 增加代表性样本数量（修改脚本中的num_samples参数）
```

### 问题3: 某些类别准确率特别低

**可能原因**:
1. 该类别样本数量不足
2. 该类别特征不明显
3. 类别间混淆

**解决方案**:
- 查看混淆矩阵，找出混淆的类别
- 检查该类别的数据质量
- 考虑增加该类别的训练数据

### 问题4: NPZ文件加载失败

**错误信息**:
```
警告: 无法解析NPZ文件结构
```

**解决方案**:
```python
# 手动检查NPZ文件结构
import numpy as np
data = np.load("path/to/file.npz")
print("Available keys:", data.files)
for key in data.files:
    print(f"{key}: shape={data[key].shape}, dtype={data[key].dtype}")
```

然后修改 `_load_npz_file` 函数以匹配实际数据结构。

## 自定义验证

### 修改每个类别的测试样本数

在 `validate_simple.py` 中:
```python
SAMPLES_PER_CLASS = 50  # 改为你需要的数量
```

在 `validate_tflite_model.py` 中:
```python
samples, labels = validator.load_dataset(max_samples_per_class=100)  # 修改这里
```

### 只测试特定类别

```python
# 在 validate_simple.py 中
CLASS_NAMES = ["Like", "Dislike", "Fist"]  # 只测试这些类别
```

### 调整预处理参数

在验证脚本的 `preprocess_input` 函数中:
```python
MAX_DISTANCE = 400  # 根据你的传感器调整
MIN_DISTANCE = 100
BACKGROUND_DISTANCE = 120
```

## 性能基准

根据原始模型文档，预期性能为:

| 指标 | FLOAT32 | FLOAT16 | INT8 | INT8 Full |
|------|---------|---------|------|-----------|
| 准确率 | 99.43% | ~99.2% | ~98.5% | ~97-98% |
| 模型大小 | ~32 KB | ~16 KB | ~11 KB | ~11 KB |
| 推理速度 | 基准 | 1.2x | 1.5x | 2x |

**注意**: 实际性能可能因数据集、硬件和实现细节而异。

## 下一步

验证完成后，根据结果:

1. **如果准确率 > 95%**:
   - ✅ 可以部署到Arduino
   - 使用生成的 `.h` 头文件
   - 参考 `CONVERSION_GUIDE.md` 中的Arduino集成指南

2. **如果准确率 80-95%**:
   - ⚠️ 可以部署，但需要监控
   - 考虑使用FLOAT16代替INT8
   - 增加量化校准数据

3. **如果准确率 < 80%**:
   - ❌ 不建议直接部署
   - 检查预处理和量化流程
   - 使用完整的转换脚本重新生成模型

## 参考资源

- [TensorFlow Lite量化指南](https://www.tensorflow.org/lite/performance/post_training_quantization)
- [模型评估最佳实践](https://www.tensorflow.org/lite/performance/model_analyzer)
